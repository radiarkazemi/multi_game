<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ¯ Ø¨Ø§Ø²ÛŒ Ø¶Ø±Ø¨</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  /* â”€â”€ lighter warm theme â”€â”€ */
  --bg:       #f0f4ff;
  --surface:  #ffffff;
  --card:     #f7f9ff;
  --border:   rgba(100,120,220,0.14);
  --accent:   #5b7fff;
  --accent2:  #8b5cf6;
  --green:    #10b981;
  --red:      #ef4444;
  --yellow:   #f59e0b;
  --text:     #1e2340;
  --muted:    #6b7280;
  --radius:   16px;
  --shadow:   0 4px 24px rgba(91,127,255,0.12);
  --shadow-lg:0 12px 40px rgba(91,127,255,0.18);
}

html, body {
  height: 100%;
  font-family: 'Vazirmatn','Tahoma',sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden;
}

/* â”€â”€ background gradient + dots â”€â”€ */
body::after {
  content:'';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse at 80% 10%, rgba(91,127,255,0.10) 0%, transparent 55%),
    radial-gradient(ellipse at 10% 80%, rgba(139,92,246,0.10) 0%, transparent 55%),
    radial-gradient(ellipse at 50% 50%, rgba(16,185,129,0.05) 0%, transparent 60%);
}

/* floating clouds â€” now visible on light bg */
.cloud {
  position: fixed; border-radius: 100px;
  background: rgba(255,255,255,0.8);
  box-shadow: 0 4px 20px rgba(91,127,255,0.1);
  animation: floatCloud linear infinite;
  pointer-events: none; z-index: 0;
}
.cloud::before,.cloud::after {
  content:''; position:absolute;
  background: rgba(255,255,255,0.8);
  border-radius: 100px;
}
.cloud-1{width:110px;height:40px;top:8%;animation-duration:50s;}
.cloud-1::before{width:54px;height:54px;top:-26px;left:15px;}
.cloud-1::after{width:64px;height:40px;top:-14px;right:14px;}
.cloud-2{width:140px;height:48px;top:65%;animation-duration:65s;animation-delay:12s;}
.cloud-2::before{width:62px;height:62px;top:-30px;left:20px;}
.cloud-2::after{width:72px;height:48px;top:-18px;right:18px;}
.cloud-3{width:90px;height:34px;top:38%;animation-duration:44s;animation-delay:26s;}
.cloud-3::before{width:44px;height:44px;top:-22px;left:12px;}
.cloud-3::after{width:52px;height:34px;top:-12px;right:12px;}
@keyframes floatCloud{from{left:-210px;}to{left:110%;}}

/* â”€â”€ screens â”€â”€ */
.screen {
  position:relative; z-index:1;
  min-height:100dvh;
  display:flex; flex-direction:column;
  justify-content:center; align-items:center;
  padding:20px 16px;
}
.screen.hidden{display:none !important;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.name-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:28px;
  padding:clamp(28px,6vw,50px);
  width:100%; max-width:440px;
  text-align:center;
  box-shadow:var(--shadow-lg);
  animation:cardIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes cardIn{from{opacity:0;transform:scale(0.9) translateY(20px);}to{opacity:1;transform:scale(1) translateY(0);}}

.brand-icon{
  font-size:62px; display:block; margin-bottom:10px;
  animation:iconFloat 3s ease-in-out infinite;
  filter:drop-shadow(0 4px 12px rgba(91,127,255,0.3));
}
@keyframes iconFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}

.brand-title{
  font-size:clamp(28px,7vw,42px); font-weight:900; letter-spacing:-1px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  margin-bottom:4px;
}
.brand-credit{
  font-size:12px; color:var(--muted); margin-bottom:4px; font-weight:600;
}
.brand-sub{color:var(--muted); font-size:14px; margin-bottom:28px;}

.name-input{
  width:100%; padding:15px 18px;
  background:var(--card); border:2px solid var(--border);
  border-radius:var(--radius);
  font-size:18px; font-family:'Vazirmatn','Tahoma',sans-serif;
  color:var(--text); text-align:right; outline:none;
  transition:border-color 0.2s, box-shadow 0.2s;
  margin-bottom:8px;
}
.name-input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(91,127,255,0.15);}
.name-input::placeholder{color:var(--muted);}
.name-error{color:var(--red); font-size:13px; min-height:20px; margin-bottom:12px; text-align:right;}

.btn-primary{
  width:100%; padding:15px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#fff; border:none; border-radius:var(--radius);
  font-size:17px; font-weight:700; font-family:'Vazirmatn','Tahoma',sans-serif;
  cursor:pointer; transition:all 0.25s;
  box-shadow:0 4px 20px rgba(91,127,255,0.35);
  margin-bottom:10px;
}
.btn-primary:hover{transform:translateY(-2px); box-shadow:0 8px 28px rgba(91,127,255,0.45);}
.btn-primary:active{transform:translateY(0);}

.btn-ghost{
  background:transparent; border:1.5px solid var(--border);
  color:var(--muted); padding:11px 20px;
  border-radius:50px; font-size:14px; font-weight:600;
  font-family:'Vazirmatn','Tahoma',sans-serif;
  cursor:pointer; transition:all 0.2s; width:100%;
}
.btn-ghost:hover{border-color:var(--accent); color:var(--accent);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.settings-card{
  background:var(--surface); border:1px solid var(--border);
  border-radius:24px; padding:clamp(22px,5vw,38px);
  width:100%; max-width:520px; box-shadow:var(--shadow-lg);
  animation:cardIn 0.4s ease;
}
.back-link{
  display:flex; align-items:center; gap:6px;
  color:var(--muted); font-size:14px; font-weight:600;
  cursor:pointer; margin-bottom:18px;
  background:none; border:none; font-family:'Vazirmatn','Tahoma',sans-serif;
  transition:color 0.2s;
}
.back-link:hover{color:var(--accent);}
.player-greeting{
  background:linear-gradient(135deg,rgba(91,127,255,0.08),rgba(139,92,246,0.08));
  border:1px solid var(--border); border-radius:12px;
  padding:12px 16px; font-size:16px; font-weight:700; color:var(--accent);
  margin-bottom:18px; text-align:center;
}
.setting-section{margin-bottom:20px;}
.setting-label{
  font-size:12px; font-weight:700; color:var(--muted);
  text-transform:uppercase; letter-spacing:1px;
  margin-bottom:10px; display:flex; align-items:center; gap:6px;
}
.chip-group{display:flex; gap:8px; flex-wrap:wrap;}
.chip{position:relative;}
.chip input[type="radio"]{position:absolute; opacity:0; width:0; height:0;}
.chip label{
  display:block; padding:9px 16px;
  background:var(--card); border:2px solid var(--border);
  border-radius:50px; cursor:pointer;
  font-size:14px; font-family:'Vazirmatn','Tahoma',sans-serif;
  font-weight:600; color:var(--muted);
  transition:all 0.2s; white-space:nowrap; user-select:none;
}
.chip label:hover{border-color:var(--accent); color:var(--accent); transform:translateY(-1px);}
.chip input:checked + label{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-color:transparent; color:#fff;
  box-shadow:0 3px 12px rgba(91,127,255,0.35);
}
.sep{height:1px; background:var(--border); margin:18px 0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.game-wrap{
  width:100%; max-width:620px;
  display:flex; flex-direction:column; gap:11px;
}
.top-bar{
  display:flex; align-items:center;
  justify-content:space-between; gap:8px;
}
.icon-btn{
  background:var(--surface); border:1.5px solid var(--border);
  border-radius:10px; padding:9px 13px;
  font-size:17px; cursor:pointer; color:var(--muted);
  transition:all 0.2s; line-height:1;
  box-shadow:var(--shadow);
}
.icon-btn:hover{color:var(--accent); border-color:var(--accent);}

.level-pill{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#fff; padding:9px 18px; border-radius:50px;
  font-size:clamp(12px,3.2vw,15px); font-weight:700;
  box-shadow:0 2px 12px rgba(91,127,255,0.3);
  text-align:center; flex:1;
}
.score-pill{
  background:var(--surface); border:1.5px solid var(--border);
  padding:9px 14px; border-radius:50px;
  font-size:14px; font-weight:700; color:var(--yellow); white-space:nowrap;
  box-shadow:var(--shadow);
}
.score-pill.bump{animation:scoreBump 0.3s ease;}
@keyframes scoreBump{0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}

.progress-track{height:6px; background:var(--card); border-radius:99px; overflow:hidden; box-shadow:inset 0 1px 3px rgba(0,0,0,0.06);}
.progress-bar{
  height:100%;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border-radius:99px; transition:width 0.5s cubic-bezier(0.4,0,0.2,1);
}
.timer-track{height:5px; background:var(--card); border-radius:99px; overflow:hidden; display:none;}
.timer-track.on{display:block;}
.timer-bar{height:100%; background:var(--green); border-radius:99px; width:100%; transition:background 0.5s;}
.timer-bar.warn  {background:var(--yellow);}
.timer-bar.danger{background:var(--red); animation:dangerPulse 0.4s infinite;}
@keyframes dangerPulse{0%,100%{opacity:1;}50%{opacity:0.4;}}

.q-meta{
  display:flex; justify-content:space-between;
  font-size:12px; color:var(--muted); font-weight:600;
}

/* answer bubble */
.answer-bubble{
  background:var(--surface); border:2px solid var(--border);
  border-radius:24px; text-align:center;
  padding:clamp(22px,5vw,38px) 20px;
  position:relative; overflow:hidden;
  box-shadow:var(--shadow);
  transition:border-color 0.3s, box-shadow 0.3s;
}
.answer-bubble::before{
  content:''; position:absolute; inset:0;
  background:radial-gradient(ellipse at 50% 0%,rgba(91,127,255,0.06),transparent 70%);
  pointer-events:none;
}
.answer-bubble.correct-glow{border-color:var(--green); box-shadow:0 0 0 4px rgba(16,185,129,0.12);}
.answer-bubble.wrong-glow  {border-color:var(--red);   box-shadow:0 0 0 4px rgba(239,68,68,0.12);}

.answer-label{font-size:11px; color:var(--muted); font-weight:700; letter-spacing:1px; text-transform:uppercase; margin-bottom:8px;}
.answer-number{
  font-size:clamp(68px,17vw,96px); font-weight:900; line-height:1;
  background:linear-gradient(135deg,var(--accent) 20%,var(--accent2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  filter:drop-shadow(0 2px 8px rgba(91,127,255,0.2));
}
.answer-number.pop{animation:numPop 0.38s cubic-bezier(0.36,0.07,0.19,0.97);}
@keyframes numPop{0%{transform:scale(0.6);opacity:0;}60%{transform:scale(1.1);}100%{transform:scale(1);opacity:1;}}

/* hint */
.hint-row{display:flex; justify-content:center; min-height:34px; align-items:center; gap:10px;}
.hint-btn{
  background:transparent; border:1.5px solid var(--border);
  border-radius:50px; padding:6px 16px;
  font-size:13px; color:var(--muted); cursor:pointer;
  font-family:'Vazirmatn','Tahoma',sans-serif; font-weight:600;
  transition:all 0.2s; display:none;
}
.hint-btn:hover{border-color:var(--yellow); color:var(--yellow);}
.hint-btn:disabled{opacity:0.35; cursor:not-allowed;}
.hint-chip{
  background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3);
  border-radius:8px; padding:6px 14px;
  font-size:14px; color:var(--yellow); font-weight:600;
  display:none; animation:chipIn 0.3s ease;
}
.hint-chip.show{display:block;}
@keyframes chipIn{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}

/* options */
.options-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
@media(min-width:560px){.options-grid{grid-template-columns:repeat(4,1fr);}}

.opt-btn{
  background:var(--surface); border:2px solid var(--border);
  border-radius:var(--radius);
  padding:clamp(14px,4vw,22px) 10px;
  font-size:clamp(16px,4.2vw,22px); font-weight:700;
  font-family:'Vazirmatn','Tahoma',sans-serif;
  color:var(--text); cursor:pointer;
  transition:all 0.22s cubic-bezier(0.4,0,0.2,1);
  text-align:center; user-select:none;
  -webkit-tap-highlight-color:transparent;
  box-shadow:var(--shadow);
  position:relative; overflow:hidden;
}
.opt-btn::after{
  content:''; position:absolute; top:-50%; left:-75%;
  width:50%; height:200%;
  background:linear-gradient(to right,transparent,rgba(91,127,255,0.08),transparent);
  transform:skewX(-20deg); transition:left 0.4s;
}
.opt-btn:hover::after{left:125%;}
.opt-btn:hover{
  border-color:var(--accent); transform:translateY(-4px);
  box-shadow:0 8px 24px rgba(91,127,255,0.2);
}
/* staggered float */
.opt-btn{animation:optFloat 3s ease-in-out infinite;}
.opt-btn:nth-child(1){animation-delay:0s;}
.opt-btn:nth-child(2){animation-delay:0.45s;}
.opt-btn:nth-child(3){animation-delay:0.9s;}
.opt-btn:nth-child(4){animation-delay:1.35s;}
@keyframes optFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);}}
.opt-btn:hover{animation-play-state:paused;}

.opt-btn.correct{
  background:rgba(16,185,129,0.1); border-color:var(--green); color:var(--green);
  animation:correctPop 0.45s ease forwards;
}
.opt-btn.wrong{
  background:rgba(239,68,68,0.08); border-color:var(--red); color:var(--red);
  animation:wrongShake 0.4s ease forwards;
}
@keyframes correctPop{0%{transform:scale(1);}35%{transform:scale(1.1);}100%{transform:scale(1);}}
@keyframes wrongShake{0%,100%{transform:translateX(0);}25%{transform:translateX(-8px);}75%{transform:translateX(8px);}}

.feedback{
  text-align:center; font-size:clamp(16px,4vw,20px);
  font-weight:700; min-height:32px; padding:4px 0;
}
.feedback.ok  {color:var(--green);}
.feedback.bad {color:var(--red);}
.feedback.info{color:var(--accent);}

/* stars burst */
.star-layer{position:fixed; inset:0; pointer-events:none; z-index:999; overflow:hidden;}
.fstar{
  position:absolute; animation:fstar 1s ease-out forwards;
}
@keyframes fstar{
  0%  {opacity:0;transform:scale(0) rotate(0deg) translateY(0);}
  35% {opacity:1;transform:scale(1.4) rotate(120deg) translateY(-18px);}
  100%{opacity:0;transform:scale(0.5) rotate(290deg) translateY(-75px);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEVEL TRANSITION OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.level-transition{
  position:fixed; inset:0; z-index:200;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  animation:transitionIn 0.4s ease, transitionOut 0.4s ease 1.6s forwards;
  pointer-events:none;
}
@keyframes transitionIn{from{opacity:0;transform:scale(1.1);}to{opacity:1;transform:scale(1);}}
@keyframes transitionOut{from{opacity:1;}to{opacity:0;}}
.level-transition.hide{display:none;}

.lt-emoji{font-size:72px; animation:ltBounce 0.4s ease both;}
@keyframes ltBounce{0%{transform:scale(0);}70%{transform:scale(1.2);}100%{transform:scale(1);}}
.lt-title{color:#fff; font-size:clamp(26px,6vw,38px); font-weight:900; margin:12px 0 6px; text-align:center;}
.lt-sub  {color:rgba(255,255,255,0.8); font-size:clamp(16px,4vw,22px); font-weight:600; text-align:center;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEADERBOARD MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay{
  position:fixed; inset:0; background:rgba(30,35,64,0.5);
  z-index:100; display:flex; align-items:center; justify-content:center;
  padding:16px; backdrop-filter:blur(6px);
  animation:overlayIn 0.2s ease;
}
.modal-overlay.hidden{display:none;}
@keyframes overlayIn{from{opacity:0;}to{opacity:1;}}

.modal{
  background:var(--surface); border:1px solid var(--border);
  border-radius:24px; width:100%; max-width:480px;
  max-height:88dvh; overflow:hidden;
  display:flex; flex-direction:column;
  box-shadow:var(--shadow-lg);
  animation:modalIn 0.28s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalIn{from{transform:scale(0.9);opacity:0;}to{transform:scale(1);opacity:1;}}

.modal-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:20px 24px 16px; border-bottom:1px solid var(--border);
}
.modal-title{font-size:20px; font-weight:900;}
.modal-close{
  background:var(--card); border:1px solid var(--border);
  border-radius:8px; padding:6px 11px; font-size:16px;
  cursor:pointer; color:var(--muted); transition:all 0.2s;
}
.modal-close:hover{color:var(--red); border-color:var(--red);}
.modal-body{overflow-y:auto; padding:16px 24px 24px; flex:1;}

.lb-tabs{display:flex; gap:6px; margin-bottom:16px; flex-wrap:wrap;}
.lb-tab{
  padding:7px 14px; border-radius:50px; font-size:13px; font-weight:600;
  font-family:'Vazirmatn','Tahoma',sans-serif;
  border:1.5px solid var(--border); background:var(--card);
  color:var(--muted); cursor:pointer; transition:all 0.2s;
}
.lb-tab.active{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-color:transparent; color:#fff;
}

.lb-list{display:flex; flex-direction:column; gap:8px;}
.lb-empty{text-align:center; color:var(--muted); padding:40px 0; font-size:15px;}
.lb-loading{text-align:center; color:var(--muted); padding:40px 0; font-size:24px;}

.lb-row{
  display:flex; align-items:center; gap:12px;
  background:var(--card); border:1.5px solid var(--border);
  border-radius:12px; padding:12px 16px;
  animation:rowIn 0.3s ease both;
}
@keyframes rowIn{from{opacity:0;transform:translateX(-10px);}to{opacity:1;transform:translateX(0);}}
.lb-row.me    {border-color:var(--accent); background:rgba(91,127,255,0.06);}
.lb-row.top-1 {border-color:var(--yellow); background:rgba(245,158,11,0.06);}
.lb-row.top-2 {border-color:#9ca3af;       background:rgba(156,163,175,0.05);}
.lb-row.top-3 {border-color:#d97706;       background:rgba(217,119,6,0.05);}

.lb-rank{font-size:20px; width:32px; text-align:center; flex-shrink:0;}
.lb-info{flex:1; min-width:0;}
.lb-name{font-size:15px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.lb-sub {font-size:12px; color:var(--muted); margin-top:2px;}
.lb-score-val{font-size:18px; font-weight:900; color:var(--yellow);}
.lb-del{
  background:none; border:none; color:var(--muted);
  cursor:pointer; font-size:16px; padding:4px 6px;
  display:none; transition:color 0.2s; border-radius:6px;
}
.lb-del:hover{color:var(--red); background:rgba(239,68,68,0.08);}
.teacher-mode .lb-del{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   END SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.end-card{
  background:var(--surface); border:1px solid var(--border);
  border-radius:28px; padding:clamp(28px,6vw,48px);
  width:100%; max-width:440px; text-align:center;
  box-shadow:var(--shadow-lg);
  animation:cardIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
.end-trophy{
  font-size:84px; display:block; margin-bottom:12px;
  animation:trophyBob 2s ease-in-out infinite;
  filter:drop-shadow(0 4px 12px rgba(245,158,11,0.3));
}
@keyframes trophyBob{0%,100%{transform:translateY(0) rotate(-4deg);}50%{transform:translateY(-12px) rotate(4deg);}}
.end-title{font-size:clamp(26px,6vw,36px); font-weight:900; margin-bottom:6px;}
.end-grade{font-size:clamp(14px,3.5vw,17px); color:var(--muted); margin-bottom:18px;}
.end-stats{
  background:var(--card); border-radius:var(--radius);
  padding:16px; margin-bottom:14px;
  display:flex; justify-content:space-around; gap:8px;
}
.end-stat-val{font-size:clamp(20px,5vw,28px); font-weight:900; color:var(--yellow);}
.end-stat-lbl{font-size:12px; color:var(--muted); margin-top:2px;}
.rank-banner{
  background:rgba(91,127,255,0.08); border:1px solid rgba(91,127,255,0.2);
  border-radius:12px; padding:13px 16px;
  margin-bottom:18px; font-size:15px; font-weight:700; color:var(--accent);
  min-height:50px; display:flex; align-items:center; justify-content:center;
}
.btn-row{display:flex; flex-direction:column; gap:10px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUPABASE CONFIG NOTICE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.config-notice{
  background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.25);
  border-radius:12px; padding:14px 16px; font-size:13px;
  color:#92400e; line-height:1.8;
}
.config-notice a{color:var(--accent);}
</style>
</head>
<body>

<!-- bg clouds -->
<div class="cloud cloud-1"></div>
<div class="cloud cloud-2"></div>
<div class="cloud cloud-3"></div>
<div class="star-layer" id="starLayer"></div>

<!-- level transition overlay (hidden by default) -->
<div class="level-transition hide" id="levelTransition">
  <div class="lt-emoji" id="ltEmoji">ğŸŠ</div>
  <div class="lt-title" id="ltTitle">Ø¢ÙØ±ÛŒÙ†!</div>
  <div class="lt-sub"   id="ltSub">Ù…Ø±Ø­Ù„Ù‡ Û² Ø´Ø±ÙˆØ¹ Ø´Ø¯</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LEADERBOARD MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay hidden" id="lbOverlay" onclick="closeLBOutside(event)">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">ğŸ† ØªØ§Ø¨Ù„ÙˆÛŒ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</div>
      <button class="modal-close" onclick="closeLB()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="lb-tabs">
        <button class="lb-tab active" onclick="setTab('all',this)">Ù‡Ù…Ù‡</button>
        <button class="lb-tab" onclick="setTab('easy',this)">ğŸ˜Š Ø³Ø§Ø¯Ù‡</button>
        <button class="lb-tab" onclick="setTab('normal',this)">ğŸ™‚ Ù…ØªÙˆØ³Ø·</button>
        <button class="lb-tab" onclick="setTab('hard',this)">ğŸ˜¤ Ø³Ø®Øª</button>
      </div>
      <div id="lbContent"><div class="lb-loading">â³</div></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: NAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="nameScreen">
  <div class="name-card">
    <span class="brand-icon">ğŸ¯</span>
    <div class="brand-title">Ø¨Ø§Ø²ÛŒ Ø¶Ø±Ø¨</div>
    <div class="brand-credit">Ø·Ø±Ø§Ø­: Ø³Ù‡ÛŒÙ„Ø§ Ù…Ù„Ú©â€ŒÙ…Ø­Ù…Ø¯ÛŒ | Ø¯Ø¨Ø³ØªØ§Ù† Ù†ÛŒØ§ÛŒØ´ Û±</div>
    <div class="brand-sub">Ø¨Ø§Ø²ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¬Ø¯ÙˆÙ„ Ø¶Ø±Ø¨</div>

    <input class="name-input" id="nameInput"
      type="text" placeholder="Ø§Ø³Ù…Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³..."
      maxlength="30" autocomplete="off"
      onkeydown="if(event.key==='Enter') goSettings()">
    <div class="name-error" id="nameError"></div>

    <button class="btn-primary" onclick="goSettings()">Ø§Ø¯Ø§Ù…Ù‡ â†</button>
    <button class="btn-ghost"   onclick="openLB()">ğŸ† ØªØ§Ø¨Ù„ÙˆÛŒ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="settingsScreen">
  <div class="settings-card">
    <button class="back-link" onclick="show('nameScreen')">â† ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
    <div class="player-greeting" id="playerGreeting">Ø³Ù„Ø§Ù…! Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØŸ ğŸ‘‹</div>

    <div class="setting-section">
      <div class="setting-label">ğŸ“‹ ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„ Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡</div>
      <div class="chip-group">
        <div class="chip"><input type="radio" id="q3"  name="qpl" value="3"><label for="q3">Û³ â€” Ø³Ø±ÛŒØ¹</label></div>
        <div class="chip"><input type="radio" id="q5"  name="qpl" value="5" checked><label for="q5">Ûµ â€” Ù…Ø¹Ù…ÙˆÙ„ÛŒ</label></div>
        <div class="chip"><input type="radio" id="q10" name="qpl" value="10"><label for="q10">Û±Û° â€” Ú©Ø§Ù…Ù„</label></div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="setting-section">
      <div class="setting-label">ğŸ® Ø³Ø·Ø­ Ø¯Ø´ÙˆØ§Ø±ÛŒ</div>
      <div class="chip-group">
        <div class="chip"><input type="radio" id="easy"   name="diff" value="easy" checked><label for="easy">ğŸ˜Š Ø³Ø§Ø¯Ù‡ â€” Ø¨Ø§ Ø±Ø§Ù‡Ù†Ù…Ø§</label></div>
        <div class="chip"><input type="radio" id="normal" name="diff" value="normal"><label for="normal">ğŸ™‚ Ù…ØªÙˆØ³Ø·</label></div>
        <div class="chip"><input type="radio" id="hard"   name="diff" value="hard"><label for="hard">ğŸ˜¤ Ø³Ø®Øª</label></div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="setting-section">
      <div class="setting-label">â±ï¸ Ø²Ù…Ø§Ù† Ù‡Ø± Ø³ÙˆØ§Ù„</div>
      <div class="chip-group">
        <div class="chip"><input type="radio" id="t0"  name="time" value="0" checked><label for="t0">Ø¨ÛŒâ€ŒÙ…Ø­Ø¯ÙˆØ¯ÛŒØª</label></div>
        <div class="chip"><input type="radio" id="t15" name="time" value="15"><label for="t15">Û±Ûµ Ø«Ø§Ù†ÛŒÙ‡</label></div>
        <div class="chip"><input type="radio" id="t30" name="time" value="30"><label for="t30">Û³Û° Ø«Ø§Ù†ÛŒÙ‡</label></div>
        <div class="chip"><input type="radio" id="t60" name="time" value="60"><label for="t60">Û¶Û° Ø«Ø§Ù†ÛŒÙ‡</label></div>
      </div>
    </div>
    <div class="sep"></div>
    <button class="btn-primary" onclick="startGame()">ğŸš€ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
    <div style="height:10px"></div>
    <button class="btn-ghost"   onclick="openLB()">ğŸ† ØªØ§Ø¨Ù„ÙˆÛŒ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="gameScreen">
  <div class="game-wrap">

    <div class="top-bar">
      <button class="icon-btn" onclick="confirmBack()">â†</button>
      <div class="level-pill" id="levelPill">Ù…Ø±Ø­Ù„Ù‡ Û± â€” Ø¬Ø¯ÙˆÙ„ Û²</div>
      <div style="display:flex;gap:6px;align-items:center">
        <div class="score-pill" id="scorePill">â­ <span id="scoreEl">Û°</span></div>
        <button class="icon-btn" onclick="openLB()">ğŸ†</button>
      </div>
    </div>

    <div class="progress-track"><div class="progress-bar" id="progBar" style="width:0%"></div></div>
    <div class="timer-track" id="timerTrack"><div class="timer-bar" id="timerBar"></div></div>

    <div class="q-meta">
      <span id="qCounter">Ø³ÙˆØ§Ù„ Û± Ø§Ø² Ûµ</span>
      <span id="qMeta">Ù…Ø±Ø­Ù„Ù‡ Û± Ø§Ø² Û¸</span>
    </div>

    <div class="answer-bubble" id="answerBubble">
      <div class="answer-label">Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨ Ú†Ù†Ø¯ØªØ§Ø³ØªØŸ</div>
      <div class="answer-number" id="answerNum">?</div>
    </div>

    <div class="hint-row">
      <button class="hint-btn" id="hintBtn" onclick="doHint()">ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ (âˆ’Û³ Ø§Ù…ØªÛŒØ§Ø²)</button>
      <div class="hint-chip" id="hintChip"></div>
    </div>

    <div class="options-grid" id="optGrid"></div>
    <div class="feedback" id="feedback"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: END
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="endScreen">
  <div class="end-card">
    <span class="end-trophy" id="endTrophy">ğŸ†</span>
    <div class="end-title"  id="endTitle">ØªØ¨Ø±ÛŒÚ©!</div>
    <div class="end-grade"  id="endGrade"></div>
    <div class="end-stats">
      <div class="end-stat"><div class="end-stat-val" id="endScore">Û°</div><div class="end-stat-lbl">Ø§Ù…ØªÛŒØ§Ø²</div></div>
      <div class="end-stat"><div class="end-stat-val" id="endMax">Û°</div><div class="end-stat-lbl">Ø­Ø¯Ø§Ú©Ø«Ø±</div></div>
      <div class="end-stat"><div class="end-stat-val" id="endPct">Û°Ùª</div><div class="end-stat-lbl">Ø¯Ø±ØµØ¯</div></div>
    </div>
    <div class="rank-banner" id="rankBanner">â³ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...</div>
    <div class="btn-row">
      <button class="btn-primary" onclick="location.reload()">ğŸ”„ Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button>
      <button class="btn-ghost"   onclick="openLB()">ğŸ† ØªØ§Ø¨Ù„ÙˆÛŒ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â”€â”€â”€ SUPABASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1. Go to https://supabase.com â†’ sign up free
   2. New project â†’ choose a name & password
   3. Go to SQL Editor â†’ run this query:
      CREATE TABLE scores (
        id SERIAL PRIMARY KEY,
        name TEXT NOT NULL,
        score INTEGER NOT NULL,
        difficulty TEXT,
        date TIMESTAMPTZ DEFAULT NOW()
      );
      ALTER TABLE scores ENABLE ROW LEVEL SECURITY;
      CREATE POLICY "allow all" ON scores FOR ALL USING (true) WITH CHECK (true);
   4. Go to Settings â†’ API â†’ copy URL and anon key below
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SB_URL = 'https://ypaqubgwiqyyxqtrgrhp.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwYXF1Ymd3aXF5eXhxdHJncmhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODIxMzksImV4cCI6MjA4NjY1ODEzOX0.xPRzIwQg0gso_CzrJA8rFMQSmevqT_wnzOpcdIwIFBo';

const SB_HEADERS = {
  'Content-Type':  'application/json',
  'apikey':        SB_KEY,
  'Authorization': 'Bearer ' + SB_KEY,
  'Prefer':        'return=representation'
};

/* â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const FARSI   = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
const toF     = n => String(n).replace(/\d/g, d => FARSI[+d]);
const $       = id => document.getElementById(id);
const LEVELS  = [2,3,4,5,6,7,8,9];
const DIFF_FA = { easy:'Ø³Ø§Ø¯Ù‡', normal:'Ù…ØªÙˆØ³Ø·', hard:'Ø³Ø®Øª' };

/* â”€â”€â”€ QUESTION POOL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   For each table, generate ALL possible multiplications (Ã—2..Ã—9),
   shuffle, then deal them out â€” no repeats until the pool is exhausted.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let questionPool = [];  // shuffled list of {table, mult} for current level

function buildPool(table) {
  // Multipliers 2â€“9 only (exclude Ã—1 as teacher requested, exclude Ã—10 too)
  const mults = [2,3,4,5,6,7,8,9];
  // Shuffle
  for (let i = mults.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [mults[i],mults[j]] = [mults[j],mults[i]];
  }
  questionPool = mults.map(m => ({table, mult:m}));
}

/* â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let playerName  = '';
let levelIdx    = 0;
let qIdx        = 1;
let score       = 0;
let answer      = 0;
let busy        = false;
let hintUsed    = false;
let qPerLevel   = 5;
let difficulty  = 'easy';
let timeLimit   = 0;
let timerSec    = 0;
let timerHandle = null;
let lbTab       = 'all';
let allScores   = [];
let teacherMode = false;

/* â”€â”€â”€ SOUNDS (Web Audio API â€” no files needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new AudioCtx();
  return audioCtx;
}

function playSound(type) {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);

    if (type === 'correct') {
      // Happy rising arpeggio
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      osc.frequency.setValueAtTime(523, ctx.currentTime);        // C5
      osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1);  // E5
      osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2);  // G5
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.5);
    } else if (type === 'wrong') {
      // Low buzz
      osc.type = 'sawtooth';
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      osc.frequency.setValueAtTime(200, ctx.currentTime);
      osc.frequency.setValueAtTime(150, ctx.currentTime + 0.15);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.3);
    } else if (type === 'levelup') {
      // Fanfare
      osc.type = 'triangle';
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      [392,523,659,784,1047].forEach((f,i) => {
        osc.frequency.setValueAtTime(f, ctx.currentTime + i*0.1);
      });
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.7);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.7);
    }
  } catch(e) { /* audio not supported â€” silent fallback */ }
}

/* â”€â”€â”€ SCREEN MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function show(id) {
  ['nameScreen','settingsScreen','gameScreen','endScreen'].forEach(s => {
    $(s).classList.toggle('hidden', s !== id);
  });
}

/* â”€â”€â”€ NAME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function goSettings() {
  const raw = $('nameInput').value.trim();
  if (!raw)         { $('nameError').textContent = 'Ù„Ø·ÙØ§Ù‹ Ø§Ø³Ù…Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³'; return; }
  if (raw.length<2) { $('nameError').textContent = 'Ø­Ø¯Ø§Ù‚Ù„ Û² Ø­Ø±Ù'; return; }
  $('nameError').textContent = '';
  playerName  = raw;
  teacherMode = (playerName.toLowerCase() === 'teacher');
  $('playerGreeting').textContent = `Ø³Ù„Ø§Ù… ${playerName}! Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØŸ ğŸ‘‹`;
  show('settingsScreen');
}

/* â”€â”€â”€ SETTINGS â†’ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startGame() {
  qPerLevel  = +document.querySelector('input[name="qpl"]:checked').value;
  difficulty = document.querySelector('input[name="diff"]:checked').value;
  timeLimit  = +document.querySelector('input[name="time"]:checked').value;
  if (difficulty==='hard' && timeLimit===0) timeLimit = 20;

  $('hintBtn').style.display = difficulty==='easy' ? 'inline-block' : 'none';
  $('timerTrack').classList.toggle('on', timeLimit > 0);

  levelIdx = 0; qIdx = 1; score = 0;
  $('scoreEl').textContent = toF(0);
  buildPool(LEVELS[0]);
  show('gameScreen');
  newQuestion();
}

function confirmBack() {
  if (!confirm('Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ú¯Ø±Ø¯ÛŒØŸ Ù¾ÛŒØ´Ø±ÙØª Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯.')) return;
  stopTimer();
  show('settingsScreen');
}

/* â”€â”€â”€ QUESTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function newQuestion() {
  if (levelIdx >= LEVELS.length) { endGame(); return; }

  busy = false; hintUsed = false;
  $('hintBtn').disabled = false;
  $('hintChip').classList.remove('show');
  $('feedback').textContent = '';
  $('feedback').className = 'feedback';
  $('answerBubble').classList.remove('correct-glow','wrong-glow');

  // Pick next from pool (refill if exhausted)
  if (questionPool.length === 0) buildPool(LEVELS[levelIdx]);
  const {table, mult} = questionPool.pop();
  answer = table * mult;

  const numEl = $('answerNum');
  numEl.textContent = toF(answer);
  numEl.classList.remove('pop');
  void numEl.offsetWidth;
  numEl.classList.add('pop');

  $('levelPill').textContent = `Ù…Ø±Ø­Ù„Ù‡ ${toF(levelIdx+1)} â€” Ø¬Ø¯ÙˆÙ„ ${toF(table)}`;
  $('qCounter').textContent  = `Ø³ÙˆØ§Ù„ ${toF(qIdx)} Ø§Ø² ${toF(qPerLevel)}`;
  $('qMeta').textContent     = `Ù…Ø±Ø­Ù„Ù‡ ${toF(levelIdx+1)} Ø§Ø² ${toF(LEVELS.length)}`;

  buildOptions(table, mult);
  updateProgress();
  startTimer();
}

/* â”€â”€â”€ OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildOptions(correctTable, correctMult) {
  const grid = $('optGrid');
  grid.innerHTML = '';

  // Generate 3 distractor EQUATIONS (different table Ã— different multiplier)
  // The display is "X Ú†Ù†Ø¯ØªØ§" style â€” show as "Û³ ØªØ§ Û´" format
  const distractors = new Set();
  let tries = 0;
  while (distractors.size < 3 && tries++ < 200) {
    const t = Math.floor(Math.random()*8)+2;  // table 2-9
    const m = Math.floor(Math.random()*8)+2;  // mult 2-9
    const prod = t * m;
    // Avoid same product as correct answer
    if (prod !== answer) {
      distractors.add(JSON.stringify({t, m, prod}));
    }
  }

  // Build option list: correct + 3 distractors
  const opts = [
    {t: correctTable, m: correctMult, prod: answer, isCorrect: true},
    ...[...distractors].map(s => ({...JSON.parse(s), isCorrect: false}))
  ];

  // Shuffle
  for (let i = opts.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [opts[i],opts[j]] = [opts[j],opts[i]];
  }

  opts.forEach(({t, m, prod, isCorrect}) => {
    const btn = document.createElement('button');
    btn.className = 'opt-btn';
    // Display: "Û³ ØªØ§ Û´" = Persian natural reading "three fours"
    btn.textContent = `${toF(m)} ØªØ§ ${toF(t)}`;
    btn.onclick = () => pick(btn, prod);
    grid.appendChild(btn);
  });
}

/* â”€â”€â”€ PICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pick(el, chosen) {
  if (busy) return;
  busy = true;
  stopTimer();

  if (chosen === answer) {
    el.classList.add('correct');
    $('answerBubble').classList.add('correct-glow');
    score += hintUsed ? 7 : 10;
    $('scoreEl').textContent = toF(score);
    const pill = $('scorePill');
    pill.classList.remove('bump'); void pill.offsetWidth; pill.classList.add('bump');
    $('feedback').textContent = hintUsed ? 'ğŸ‘ Ø¯Ø±Ø³Øª! (Ø¨Ø§ Ø±Ø§Ù‡Ù†Ù…Ø§)' : randPraise();
    $('feedback').className = 'feedback ok';
    playSound('correct');
    spawnStars();

    qIdx++;
    if (qIdx > qPerLevel) {
      levelIdx++; qIdx = 1;
      if (levelIdx < LEVELS.length) {
        buildPool(LEVELS[levelIdx]);
        // Show full-screen level transition
        setTimeout(() => showLevelTransition(levelIdx, () => {
          newQuestion();
        }), 600);
        return;
      }
    }
    setTimeout(() => { $('feedback').textContent=''; newQuestion(); }, 1300);

  } else {
    el.classList.add('wrong');
    $('answerBubble').classList.add('wrong-glow');
    $('feedback').textContent = randWrong();
    $('feedback').className = 'feedback bad';
    playSound('wrong');
    setTimeout(() => {
      el.classList.remove('wrong');
      $('answerBubble').classList.remove('wrong-glow');
      $('feedback').textContent = '';
      busy = false;
      if (timeLimit > 0) resumeTimer();
    }, 900);
  }
}

/* â”€â”€â”€ LEVEL TRANSITION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showLevelTransition(newLevelIdx, callback) {
  playSound('levelup');
  const table = LEVELS[newLevelIdx];
  const el = $('levelTransition');
  $('ltEmoji').textContent = ['ğŸŠ','ğŸš€','â­','ğŸ”¥','ğŸ’','ğŸ’¡','ğŸŒŸ','ğŸ†'][newLevelIdx % 8];
  $('ltTitle').textContent = `Ø¢ÙØ±ÛŒÙ†! Ù…Ø±Ø­Ù„Ù‡ ${toF(newLevelIdx+1)}`;
  $('ltSub').textContent   = `Ø­Ø§Ù„Ø§ Ø¬Ø¯ÙˆÙ„ Ø¶Ø±Ø¨ ${toF(table)} Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´Ù‡`;
  el.classList.remove('hide');
  // Remove after animation completes (2s total)
  setTimeout(() => {
    el.classList.add('hide');
    callback();
  }, 2100);
}

const PRAISES = ['ğŸ‰ Ø¢ÙØ±ÛŒÙ†! Ø¹Ø§Ù„ÛŒÙ‡!','ğŸŒŸ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡!','ğŸ’ª Ø¯Ø±Ø³ØªÙ‡!','ğŸ”¥ Ù…Ø­Ø´Ø±Ù‡!','âœ¨ Ù…Ù…ØªØ§Ø²!','âš¡ Ø³Ø±ÛŒØ¹!','ğŸ‘ Ø¨Ø§Ø±ÛŒÚ©Ù„Ø§!'];
const WRONGS  = ['âŒ Ù†Ù‡ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡!','ğŸ˜… Ø§Ø´ØªØ¨Ø§Ù‡Ù‡!','ğŸ¤” Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± ÙÚ©Ø± Ú©Ù†!','ğŸ˜¬ Ù†Ø²Ø¯ÛŒÚ© Ø¨ÙˆØ¯!'];
const randPraise = () => PRAISES[Math.floor(Math.random()*PRAISES.length)];
const randWrong  = () => WRONGS [Math.floor(Math.random()*WRONGS.length)];

/* â”€â”€â”€ HINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function doHint() {
  if (hintUsed) return;
  hintUsed = true;
  $('hintBtn').disabled = true;
  const table = LEVELS[levelIdx];
  const chip  = $('hintChip');
  chip.textContent = `${toF(answer/table)} ØªØ§ ${toF(table)} = ${toF(answer)}`;
  chip.classList.add('show');
  setTimeout(() => chip.classList.remove('show'), 4500);
}

/* â”€â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startTimer() {
  if (!timeLimit) return;
  timerSec = timeLimit;
  const bar = $('timerBar');
  bar.style.transition='none'; bar.style.width='100%'; bar.className='timer-bar';
  void bar.offsetWidth;
  bar.style.transition=`width ${timeLimit}s linear`; bar.style.width='0%';
  timerHandle = setInterval(tickTimer, 1000);
}
function resumeTimer() {
  if (!timeLimit || timerSec<=0) return;
  $('timerBar').style.transition=`width ${timerSec}s linear`;
  $('timerBar').style.width='0%';
  timerHandle = setInterval(tickTimer, 1000);
}
function stopTimer() { clearInterval(timerHandle); timerHandle=null; }
function tickTimer() {
  timerSec--;
  const pct = timerSec/timeLimit;
  $('timerBar').className='timer-bar'+(pct<0.2?' danger':pct<0.4?' warn':'');
  if (timerSec<=0) { stopTimer(); onTimeout(); }
}
function onTimeout() {
  if (busy) return;
  busy = true;
  playSound('wrong');
  $('feedback').textContent='â° ÙˆÙ‚Øª ØªÙ…Ø§Ù… Ø´Ø¯!';
  $('feedback').className='feedback bad';
  setTimeout(() => {
    $('feedback').textContent='';
    qIdx++;
    if (qIdx>qPerLevel) { levelIdx++; qIdx=1; if(levelIdx<LEVELS.length) buildPool(LEVELS[levelIdx]); }
    newQuestion();
  }, 1600);
}

/* â”€â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateProgress() {
  const done  = levelIdx*qPerLevel + (qIdx-1);
  const total = LEVELS.length*qPerLevel;
  $('progBar').style.width=(done/total*100)+'%';
}

/* â”€â”€â”€ STARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function spawnStars() {
  const layer = $('starLayer');
  const emojis = ['â­','ğŸŒŸ','âœ¨','ğŸ’«','ğŸ‰','ğŸ’¥'];
  for (let i=0; i<6; i++) {
    const s = document.createElement('div');
    s.className='fstar';
    s.textContent = emojis[Math.floor(Math.random()*emojis.length)];
    s.style.left   = (5+Math.random()*90)+'%';
    s.style.top    = (10+Math.random()*75)+'%';
    s.style.fontSize=(18+Math.random()*16)+'px';
    s.style.animationDelay=(i*0.1)+'s';
    layer.appendChild(s);
    setTimeout(()=>s.remove(), 1300);
  }
}

/* â”€â”€â”€ SUPABASE API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function isConfigured() {
  return SB_URL !== 'YOUR_SUPABASE_URL' && SB_KEY !== 'YOUR_SUPABASE_ANON_KEY';
}

async function fetchScores() {
  if (!isConfigured()) return [];
  const res = await fetch(`${SB_URL}/rest/v1/scores?select=*&order=score.desc&limit=50`, {
    headers: SB_HEADERS
  });
  if (!res.ok) { const t=await res.text(); throw new Error(`${res.status}: ${t}`); }
  return res.json();
}

async function upsertScore(entry) {
  if (!isConfigured()) return null;
  // Check if player already has a score
  const res1 = await fetch(
    `${SB_URL}/rest/v1/scores?name=eq.${encodeURIComponent(entry.name)}&select=id,score`,
    { headers: SB_HEADERS }
  );
  const existing = await res1.json();

  if (existing.length > 0) {
    if (existing[0].score >= entry.score) return { rank: null }; // not a new best
    // Update existing row
    await fetch(`${SB_URL}/rest/v1/scores?id=eq.${existing[0].id}`, {
      method: 'PATCH',
      headers: SB_HEADERS,
      body: JSON.stringify({ score: entry.score, difficulty: entry.difficulty, date: new Date().toISOString() })
    });
  } else {
    // Insert new row
    await fetch(`${SB_URL}/rest/v1/scores`, {
      method: 'POST',
      headers: SB_HEADERS,
      body: JSON.stringify({ name: entry.name, score: entry.score, difficulty: entry.difficulty })
    });
  }
  return true;
}

async function deleteScoreByName(name) {
  await fetch(`${SB_URL}/rest/v1/scores?name=eq.${encodeURIComponent(name)}`, {
    method: 'DELETE', headers: SB_HEADERS
  });
}

/* â”€â”€â”€ END GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function endGame() {
  const max = LEVELS.length*qPerLevel*10;
  const pct = score/max;
  const [trophy,title,grade] =
    pct>=0.9 ? ['ğŸ†','Ø¹Ø§Ù„ÛŒ!','ØªÙˆ ÛŒÙ‡ Ù‚Ù‡Ø±Ù…Ø§Ù† Ø¬Ø¯ÙˆÙ„ Ø¶Ø±Ø¨ÛŒ! ğŸ”¥'] :
    pct>=0.7 ? ['ğŸ¥‡','Ø¢ÙØ±ÛŒÙ†!','Ú©Ø§Ø±Øª Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨ Ø¨ÙˆØ¯ ğŸ‘'] :
    pct>=0.5 ? ['ğŸ¥ˆ','Ø®ÙˆØ¨ Ø¨ÙˆØ¯!','Ø¨Ø§ ØªÙ…Ø±ÛŒÙ† Ø¨Ù‡ØªØ± Ù…ÛŒâ€ŒØ´ÛŒ ğŸ’ª'] :
               ['ğŸ¯','ØªÙ„Ø§Ø´ Ú©Ù†!','Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ØŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ! ğŸ˜Š'];

  $('endTrophy').textContent=trophy; $('endTitle').textContent=title;
  $('endGrade').textContent=grade;   $('endScore').textContent=toF(score);
  $('endMax').textContent=toF(max);  $('endPct').textContent=toF(Math.round(pct*100))+'Ùª';
  $('rankBanner').textContent='â³ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²...';
  show('endScreen');
  spawnStars(); spawnStars();
  playSound('levelup');

  if (!isConfigured()) {
    $('rankBanner').textContent='âš™ï¸ Supabase Ù‡Ù†ÙˆØ² ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡';
    return;
  }
  try {
    await upsertScore({ name:playerName, score, difficulty });
    const all    = await fetchScores();
    const rank   = all.findIndex(s=>s.name.toLowerCase()===playerName.toLowerCase())+1;
    $('rankBanner').textContent =
      rank===1 ? `ğŸ¥‡ ØªÙˆ Ø§ÙˆÙ„ Ø´Ø¯ÛŒ Ø§Ø² ${toF(all.length)} Ù†ÙØ±! ğŸ‰`
               : `ğŸ… Ø±ØªØ¨Ù‡ ${toF(rank)} Ø§Ø² ${toF(all.length)} Ù†ÙØ±`;
  } catch(e) {
    console.error(e);
    $('rankBanner').textContent='âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª: '+e.message;
  }
}

/* â”€â”€â”€ LEADERBOARD UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function openLB() {
  $('lbOverlay').classList.remove('hidden');
  await loadLB();
}
function closeLB() { $('lbOverlay').classList.add('hidden'); }
function closeLBOutside(e) { if(e.target===$('lbOverlay')) closeLB(); }

function setTab(f, btn) {
  lbTab=f;
  document.querySelectorAll('.lb-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderLB();
}

async function loadLB() {
  $('lbContent').innerHTML='<div class="lb-loading">â³</div>';
  if (!isConfigured()) {
    $('lbContent').innerHTML=`
      <div class="config-notice">
        âš™ï¸ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØªØ§Ø¨Ù„ÙˆÛŒ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Supabase Ø±Ùˆ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†.<br>
        Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø±Ùˆ ØªÙˆÛŒ README.md Ø¨Ø¨ÛŒÙ†.
      </div>`;
    return;
  }
  try {
    allScores = await fetchScores();
    renderLB();
  } catch(e) {
    $('lbContent').innerHTML=`<div class="lb-empty">âš ï¸ Ø®Ø·Ø§: ${esc(e.message)}</div>`;
  }
}

function renderLB() {
  const filtered = lbTab==='all' ? allScores : allScores.filter(s=>s.difficulty===lbTab);
  filtered.sort((a,b)=>b.score-a.score);
  if (!filtered.length) {
    $('lbContent').innerHTML='<div class="lb-empty">ğŸœï¸ Ù‡Ù†ÙˆØ² Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡!</div>'; return;
  }
  const medal=i=>['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||`${toF(i+1)}.`;
  const cls  =i=>['top-1','top-2','top-3'][i]||'';
  const rows=filtered.map((s,i)=>{
    const isMe=s.name.toLowerCase()===playerName.toLowerCase();
    const date=s.date?new Date(s.date).toLocaleDateString('fa-IR',{month:'short',day:'numeric'}):'';
    return `
      <div class="lb-row ${cls(i)} ${isMe?'me':''}" style="animation-delay:${i*0.04}s">
        <div class="lb-rank">${medal(i)}</div>
        <div class="lb-info">
          <div class="lb-name">${esc(s.name)}${isMe?' (ØªÙˆ)':''}</div>
          <div class="lb-sub">${DIFF_FA[s.difficulty]||''} ${date?'Â· '+date:''}</div>
        </div>
        <div class="lb-score-val">${toF(s.score)}</div>
        <button class="lb-del" onclick="delEntry('${esc(s.name)}')">ğŸ—‘</button>
      </div>`;
  }).join('');
  $('lbContent').innerHTML=`<div class="lb-list ${teacherMode?'teacher-mode':''}">${rows}</div>`;
}

async function delEntry(name) {
  if (!confirm(`Ø­Ø°Ù Ø§Ù…ØªÛŒØ§Ø² "${name}"ØŸ`)) return;
  await deleteScoreByName(name);
  allScores=allScores.filter(s=>s.name.toLowerCase()!==name.toLowerCase());
  renderLB();
}

const esc=s=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
</script>
</body>
</html>